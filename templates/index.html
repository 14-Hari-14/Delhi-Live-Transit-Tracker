<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Delhi Public Transport Map</title>

    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""
    />

    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""
    ></script>

    <style>
      /* Basic styling to make the map fill the entire page */
      html,
      body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
      #map {
        height: 100vh; /* vh stands for "viewport height" */
        width: 100vw; /* vw stands for "viewport width" */
      }
    </style>
  </head>
  <body>
    <div id="map"></div>

    <script>
      // 3. Initialize the map and set its view to Delhi's coordinates
      const map = L.map("map").setView([28.6139, 77.209], 11);

      // 4. Add a tile layer to the map (the map's background image)
      // We're using OpenStreetMap, a free and open map provider.
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution: "Â© OpenStreetMap contributors",
      }).addTo(map);

      // 5. Create a custom icon for the buses ðŸšŒ
      const busIcon = L.icon({
        iconUrl: "https://img.icons8.com/plasticine/100/bus.png",
        iconSize: [38, 38], // size of the icon
        iconAnchor: [19, 38], // point of the icon which will correspond to marker's location
        popupAnchor: [0, -40], // point from which the popup should open relative to the iconAnchor
      });

      // 6. Create a layer group to hold the bus markers. This makes it easy
      // to clear all old markers at once before adding new ones.
      let busLayer = L.layerGroup().addTo(map);

      // 7. This is the main function to fetch data and update the map
      async function updateBusLocations() {
        try {
          // Fetch data from our backend API endpoint
          const response = await fetch(
            "http://127.0.0.1:5001/api/vehicle_positions"
          );
          const vehicles = await response.json();

          // Clear all existing markers from the bus layer
          busLayer.clearLayers();

          console.log(`Updating map with ${vehicles.length} buses...`);

          // Loop through each vehicle from the API response
          vehicles.forEach((vehicle) => {
            // Create a marker on the map for the vehicle
            const marker = L.marker([vehicle.lat, vehicle.lon], {
              icon: busIcon,
            });

            // Add a popup that shows the vehicle's ID when clicked
            marker.bindPopup(`<b>Bus ID:</b> ${vehicle.id}`);

            // Add the new marker to our layer group
            marker.addTo(busLayer);
          });
        } catch (error) {
          console.error("Error fetching or updating bus locations:", error);
        }
      }

      // 8. Run the function once immediately when the page loads
      updateBusLocations();

      // 9. Set an interval to automatically run the function every 10 seconds (10000 milliseconds)
      setInterval(updateBusLocations, 10000);
    </script>
  </body>
</html>
