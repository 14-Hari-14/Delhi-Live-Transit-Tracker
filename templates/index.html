<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Delhi Public Transport Map</title>

    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />

    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css"
    />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css"
    />

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster-src.js"></script>

    <script src="https://unpkg.com/leaflet.marker.slideto@0.2.0/Leaflet.Marker.SlideTo.js"></script>

    <style>
      html,
      body,
      #map {
        height: 100%;
        margin: 0;
        padding: 0;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>

    <script>
      const map = L.map("map").setView([28.6139, 77.209], 11);

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution: "Â© OpenStreetMap contributors",
      }).addTo(map);

      const busIcon = L.icon({
        iconUrl: "https://img.icons8.com/plasticine/100/bus.png",
        iconSize: [38, 38],
        iconAnchor: [19, 38],
        popupAnchor: [0, -40],
      });

      // Use a MarkerClusterGroup for clean display
      let markerGroup = L.markerClusterGroup();
      map.addLayer(markerGroup);

      // NEW: Use an object to store references to our markers by their ID
      let busMarkers = {};

      async function updateBusLocations() {
        try {
          const response = await fetch(
            "http://127.0.0.1:5001/api/vehicle_positions"
          );
          const vehicles = await response.json();

          console.log(`Updating map with ${vehicles.length} buses...`);

          // Get a list of vehicle IDs from the latest API fetch
          const receivedVehicleIds = new Set(vehicles.map((v) => v.id));

          vehicles.forEach((vehicle) => {
            const vehicleId = vehicle.id;
            const newPosition = [vehicle.lat, vehicle.lon];

            // Check if this bus marker already exists
            if (busMarkers[vehicleId]) {
              // If it exists, slide it to the new position
              busMarkers[vehicleId].slideTo(newPosition, {
                duration: 9000, // Animate over 9 seconds
                keepAtCenter: false,
              });
            } else {
              // If it's a new bus, create a new marker
              const newMarker = L.marker(newPosition, { icon: busIcon });
              newMarker.bindPopup(`<b>Bus ID:</b> ${vehicleId}`);

              // Add it to our cluster group and our reference object
              markerGroup.addLayer(newMarker);
              busMarkers[vehicleId] = newMarker;
            }
          });

          // Clean up old markers: Remove markers for buses that are no longer in the API feed
          for (const vehicleId in busMarkers) {
            if (!receivedVehicleIds.has(vehicleId)) {
              markerGroup.removeLayer(busMarkers[vehicleId]);
              delete busMarkers[vehicleId];
            }
          }
        } catch (error) {
          console.error("Error fetching or updating bus locations:", error);
        }
      }

      updateBusLocations();
      setInterval(updateBusLocations, 10000);
    </script>
  </body>
</html>
