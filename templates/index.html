<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Delhi Public Transport Map</title>

    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />

    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css"
    />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css"
    />

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster-src.js"></script>

    <style>
      html,
      body,
      #map {
        height: 100%;
        margin: 0;
        padding: 0;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>

    <script>
      const map = L.map("map").setView([28.6139, 77.209], 11);

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution: "Â© OpenStreetMap contributors",
      }).addTo(map);

      const busIcon = L.icon({
        iconUrl: "https://img.icons8.com/plasticine/100/bus.png",
        iconSize: [38, 38],
        iconAnchor: [19, 38],
        popupAnchor: [0, -40],
      });

      // CHANGED: Use a MarkerClusterGroup instead of a LayerGroup
      let markers = L.markerClusterGroup();

      async function updateBusLocations() {
        try {
          const response = await fetch(
            "http://127.0.0.1:5001/api/vehicle_positions"
          );
          const vehicles = await response.json();

          // Clear existing markers from the cluster group
          markers.clearLayers();

          console.log(`Updating map with ${vehicles.length} buses...`);

          vehicles.forEach((vehicle) => {
            const marker = L.marker([vehicle.lat, vehicle.lon], {
              icon: busIcon,
            });
            marker.bindPopup(`<b>Bus ID:</b> ${vehicle.id}`);

            // Add the marker to the cluster group instead of adding it directly to the map
            markers.addLayer(marker);
          });

          // Add the entire cluster group to the map
          map.addLayer(markers);
        } catch (error) {
          console.error("Error fetching or updating bus locations:", error);
        }
      }

      updateBusLocations();
      setInterval(updateBusLocations, 10000);
    </script>
  </body>
</html>
